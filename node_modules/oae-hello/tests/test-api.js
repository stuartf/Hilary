var _ = require('underscore');
var assert = require('assert');

var RestAPI = require('oae-rest');
var RestContext = require('oae-rest/lib/model').RestContext;
var RestUtil = require('oae-rest/lib/util');
var TestsUtil = require('oae-tests/lib/util');

var camAdminRestContext = null;
var anonymousRestContext = null;

before(function(callback) {
    camAdminRestContext = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
    anonymousRestContext = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
    callback();
});

describe('Color List', function() {
    it('verify we can get the list of colors', function(callback) {
        RestUtil.RestRequest(anonymousRestContext, '/api/favorite/list', 'GET', null, function(err, data) {
            assert.ok(!err);
            _.each(data, function(color) {
                assert.ok(color.colorId);
                assert.ok(color.hex);
            });
            callback();
        });
    });
});

describe('Favorite Colors', function() {
    it('verify we can save a favorite color', function(callback){
        // Make a test user
        TestsUtil.generateTestUsers(camAdminRestContext, 1, function(err, testUsers) {
            assert.ok(!err);
            var user = testUsers[_.keys(testUsers)[0]];
            // Make sure the user doesn't have a favorite
            RestUtil.RestRequest(user.restContext, '/api/favorite', 'GET', null, function(err, data) {
                assert.ok(!err);
                assert.ok(!data.colorId);
                // Set the user's favorite color to red
                RestUtil.RestRequest(user.restContext, '/api/favorite/red', 'POST', null, function(err) {
                    assert.ok(!err);
                    // Get the user's favorite color and verify that it's red
                    RestUtil.RestRequest(user.restContext, '/api/favorite', 'GET', null, function(err, data) {
                        assert.ok(!err);
                        assert.equal(data.colorId, 'red');
                        // Set the user's favorite color to yellow
                        RestUtil.RestRequest(user.restContext, '/api/favorite/yellow', 'POST', null, function(err) {
                            assert.ok(!err);
                            // Get the user's favorite color and verify that it's yellow
                            RestUtil.RestRequest(user.restContext, '/api/favorite', 'GET', null, function(err, data) {
                                assert.ok(!err);
                                assert.equal(data.colorId, 'yellow');

                                callback();
                            });
                        });
                    });
                });
            });
        });
    });

    it('verify we can not save an invalid color', function(callback){
        callback();
    });

    it('verify anonymous can not save a favorite color', function(callback){
        RestUtil.RestRequest(anonymousRestContext, '/api/favorite/red', 'POST', null, function(err, data) {
            assert.ok(err);
            assert.equal(err.code, 400);
            callback();
        });
    });

    it('verify anonymous can not get a favorite color', function(callback){
        RestUtil.RestRequest(anonymousRestContext, '/api/favorite', 'GET', null, function(err, data) {
            assert.ok(err);
            assert.equal(err.code, 401);
            callback();
        });
    });
});
